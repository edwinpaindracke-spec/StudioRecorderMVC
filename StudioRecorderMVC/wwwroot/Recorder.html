<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Studio Recorder</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #2a2a39, #1b1b26);
            margin: 0;
            padding: 50px;
            color: white;
        }

        h1 {
            text-align: center;
            font-size: 2.8rem;
            margin-bottom: 30px;
        }

        /* --- Top Buttons --- */
        .top-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .btn {
            padding: 12px 22px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #6a5acd;
            color: white;
            transition: .25s;
        }

            .btn:hover {
                background: #806bff;
                transform: scale(1.05);
            }

        input[type="file"] {
            display: none;
        }

        .file-label {
            padding: 12px 22px;
            background: #44425a;
            border-radius: 8px;
            cursor: pointer;
            transition: .25s;
        }

            .file-label:hover {
                background: #55536c;
            }

        /* --- Controls Area --- */
        .controls-box {
            max-width: 600px;
            margin: 0 auto;
            background: #ffffff12;
            padding: 30px;
            border-radius: 16px;
            backdrop-filter: blur(6px);
            box-shadow: 0 0 25px rgba(0,0,0,0.35);
        }

        .transport {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
        }

            .transport button {
                padding: 14px 18px;
                font-size: 1.2rem;
                border-radius: 8px;
                border: none;
                background: #ffffff20;
                color: white;
                cursor: pointer;
                transition: 0.25s;
            }

                .transport button:hover {
                    background: #ffffff35;
                    transform: scale(1.1);
                }

        audio {
            width: 100%;
            margin-top: 15px;
            border-radius: 10px;
        }

        /* --- Meter Bar --- */
        .meter {
            width: 100%;
            height: 12px;
            background: #555;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            position: absolute;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4caf50, #e91e63);
            transition: width 0.1s;
        }

        /* --- Effects Panel --- */
        .effects-panel {
            margin-top: 30px;
            background: #ffffff18;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 0 20px rgba(0,0,0,0.35);
        }

            .effects-panel h2 {
                margin-bottom: 15px;
                font-size: 1.4rem;
            }

            .effects-panel label {
                display: block;
                margin-top: 15px;
                font-size: 1rem;
                opacity: 0.9;
            }

            .effects-panel input[type="range"] {
                width: 100%;
                margin-top: 5px;
            }
    </style>
</head>
<body>

    <h1>🎙️ Studio Recorder</h1>

    <div class="top-buttons">
        <button id="newRecordBtn" class="btn">
            <i class="fa-solid fa-circle-dot"></i> New Recording

        </button>

        <label class="file-label">
            <i class="fa-solid fa-file-arrow-up"></i> Upload Audio
            <input type="file" id="uploadInput" accept="audio/*" style="display:none;" />
            <button id="uploadBtn" class="btn"><i class="fa-solid fa-upload"></i> Upload Audio</button>

        </label>
    </div>
    <div class="uploaded-section">
        <h3 style="color:white; margin-top:25px;">Uploaded Audio</h3>
        <audio id="uploadedPlayer" controls style="width:100%; margin-top:10px;"></audio>
    </div>

    <div class="controls-box">

        <div class="transport">
            <button id="rewindBtn"><i class="fa-solid fa-backward"></i></button>
            <button id="playBtn"><i class="fa-solid fa-play"></i></button>
            <button id="forwardBtn"><i class="fa-solid fa-forward"></i></button>
        </div>

        <audio id="audioPlayback" controls></audio>

        <div class="meter">
            <div class="meter-fill" id="meterFill"></div>
        </div>

        <!-- 🔥 EFFECTS PANEL ADDED HERE -->
        <div class="effects-panel">
            <h2>🎚️ Audio Effects</h2>

            <label>Reverb</label>
            <input type="range" min="0" max="1" step="0.01" id="reverbSlider">

            <label>Bass Boost</label>
            <input type="range" min="0" max="20" id="bassSlider">

            <label>Treble Boost</label>
            <input type="range" min="-20" max="20" id="trebleSlider">

            <label>Master Compressor</label>
            <input type="range" min="0" max="1" step="0.01" id="compressorSlider">

            <label>Playback Speed / Pitch</label>
            <input type="range" min="0.5" max="2" step="0.01" id="speedSlider">
        </div>
    </div>

    <script>

        // === UPLOAD AUDIO LOGIC ===
        const uploadBtn = document.getElementById("uploadBtn");
        const uploadInput = document.getElementById("uploadInput");
        const uploadedPlayer = document.getElementById("uploadedPlayer");

        uploadBtn.onclick = () => uploadInput.click();

        uploadInput.onchange = async () => {
            const file = uploadInput.files[0];
            if (!file) return;

            // Preview instantly
            uploadedPlayer.src = URL.createObjectURL(file);

            // Upload to server
            const formData = new FormData();
            formData.append("beatFile", file);

            const response = await fetch("/Upload/UploadBeat", {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                const savedPath = await response.text();
                console.log("Saved to:", savedPath);
            } else {
                alert("Upload failed.");
            }
        };


        let mediaRecorder;
        let chunks = [];

        const playBtn = document.getElementById("playBtn");
        const newRecordBtn = document.getElementById("newRecordBtn");
        const audioPlayback = document.getElementById("audioPlayback");
        const meterFill = document.getElementById("meterFill");

        // Meter animation
        setInterval(() => {
            if (!audioPlayback.paused && !audioPlayback.ended) {
                const level = Math.random() * 100;
                meterFill.style.width = level + "%";
            } else {
                meterFill.style.width = "0%";
            }
        }, 120);

        // Start new recording
        newRecordBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: "audio/wav" });
                chunks = [];
                audioPlayback.src = URL.createObjectURL(blob);

                const formData = new FormData();
                formData.append("audioFile", blob, "recording.wav");

                fetch("/Audio/Upload", {
                    method: "POST",
                    body: formData
                });
            };

            mediaRecorder.start();
            newRecordBtn.innerHTML = "<i class='fa-solid fa-stop'></i> Stop Recording";
            newRecordBtn.onclick = stopRecording;
        };

        function stopRecording() {
            mediaRecorder.stop();
            newRecordBtn.innerHTML = "<i class='fa-solid fa-circle-dot'></i> New Recording";
            newRecordBtn.onclick = startNewRecording;
        }

        function startNewRecording() {
            newRecordBtn.onclick();
        }

        // --- AUDIO EFFECTS ENGINE ---
        const audioContext = new AudioContext();
        const sourceNode = audioContext.createMediaElementSource(audioPlayback);

        const reverb = audioContext.createConvolver();
        const bassEQ = audioContext.createBiquadFilter();
        bassEQ.type = "lowshelf";

        const trebleEQ = audioContext.createBiquadFilter();
        trebleEQ.type = "highshelf";

        const compressor = audioContext.createDynamicsCompressor();

        // Chain
        sourceNode
            .connect(bassEQ)
            .connect(trebleEQ)
            .connect(compressor)
            .connect(audioContext.destination);

        // Load simple reverb impulse response
        fetch("https://cdn.jsdelivr.net/gh/mdn/webaudio-examples@master/decodeAudioData/viper.ogg")
            .then(res => res.arrayBuffer())
            .then(buf => audioContext.decodeAudioData(buf))
            .then(decoded => reverb.buffer = decoded);

        // Sliders
        document.getElementById("reverbSlider").oninput = e => {
            sourceNode.disconnect();
            if (e.target.value > 0)
                sourceNode.connect(reverb).connect(bassEQ);
            else
                sourceNode.connect(bassEQ);
        };

        document.getElementById("bassSlider").oninput = e =>
            bassEQ.gain.value = e.target.value;

        document.getElementById("trebleSlider").oninput = e =>
            trebleEQ.gain.value = e.target.value;

        document.getElementById("compressorSlider").oninput = e =>
            compressor.threshold.value = -40 + (e.target.value * 40);

        document.getElementById("speedSlider").oninput = e =>
            audioPlayback.playbackRate = e.target.value;

    </script>

</body>
</html>